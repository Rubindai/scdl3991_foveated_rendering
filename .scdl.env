# ================= SCDL Pipeline Config (.scdl.env) =================
# This file is auto-loaded by run_windows_blender_wsl.sh from the repo root.
# Edit values here to control preview, DINO, and final render behavior.

# -------- Project / Paths --------
# WSL path to the project root (defaults to script dir if unset)
SCDL_PROJECT_DIR=/home/rubin/uni/scdl3991_foveated_rendering

# WSL path to Windows Blender executable
BLENDER_EXE=/mnt/d/Programs/blender/blender.exe

# Blend file to open (you can also pass as first arg to the launcher)
BLEND_FILE=blender_files/office.blend


# -------- Mask / ROI Generation (DINO) --------

# Foveation budget (fraction of pixels the ROI may cover).
SCDL_ROI_AREA=0.15

# DINO repo/weights (local clone + weights path).
SCDL_DINO_REPO=/home/rubin/uni/scdl3991_foveated_rendering/dinov3
# SCDL_DINO_WEIGHTS=/home/rubin/uni/scdl3991_foveated_rendering/dinov3_vits16_pretrain_lvd1689m-08c60483.pth
SCDL_DINO_WEIGHTS=/home/rubin/uni/scdl3991_foveated_rendering/dinov3_vitl16_pretrain_lvd1689m-8aa4cbdd.pth

# ----- Saliency inference -----
# Multi-scale input sizes (include 448 for tighter token grid).
SCDL_MASK_SCALES=336,392,448
# Fuse last N transformer blocks (stabler semantics).
SCDL_MASK_LAYERS=4
# Main method: CLS–patch cosine ('kmeans' is a robust fallback).
SCDL_MASK_METHOD=cls
# Uniqueness prior (discourages repetitive textures).
SCDL_MASK_UNIQ_K=8
SCDL_MASK_UNIQ_WEIGHT=0.20
# Do NOT widen edges using the mask’s own gradient (keeps contours tight).
SCDL_MASK_EDGE_WEIGHT=0.0
# Peak emphasis; higher => sparser/Sharper saliency.
SCDL_MASK_GAMMA=2.0
# Saliency smoothing kernel; 1 = OFF (max sharpness).
SCDL_MASK_SMOOTH_K=1
# Saliency overlay tint (red alpha) for debugging previews.
SCDL_MASK_OVERLAY_ALPHA=0.6
# Mixed precision on CUDA for speed (ignored on CPU).
SCDL_MASK_AMP=1

# ----- GrabCut refinement (edge-aware snap to contours) -----
# Enable GrabCut refinement (requires OpenCV).
SCDL_MASK_USE_GRABCUT=1
# Iterations (more = stronger snap).
SCDL_MASK_GRABCUT_ITERS=10
# Seed thresholds from saliency quantiles (foreground / background).
SCDL_GC_LO_Q=0.20
SCDL_GC_HI_Q=0.80
# Pixels at image border forced to background (helps avoid spillover).
SCDL_GC_BORDER=8

# ----- Secondary refinement (watershed segmentation) -----
# Produces tight, single-object masks when DINO is diffuse.
SCDL_MASK_WATERSHED=1
SCDL_WS_LO_Q=0.30
SCDL_WS_HI_Q=0.92
SCDL_WS_BORDER=6
SCDL_WS_KERNEL=5
SCDL_WS_FG_CLOSE=1
SCDL_WS_BG_OPEN=1
SCDL_WS_SEG_CLOSE=0
SCDL_WS_BLEND=0.45
SCDL_WS_BLUR=0.8

# ----- ROI post-proc / selection -----
# Mode: 'seeded' grows a single connected region from peak (stable & crisp).
#       'bestrect' searches a fixed-area rectangle (fast + simple).
SCDL_ROI_MODE=seeded
# Aspect ratios to try (used by bestrect; kept here for completeness).
SCDL_ROI_ASPECTS=0.5,0.75,1.0,1.25,1.6,2.0,2.5
# Search stride in pixels (bestrect only).
SCDL_ROI_STRIDE=4
# Connectivity for seeded growth (8 includes diagonals).
SCDL_ROI_CONNECTIVITY=8
# Bridge tiny gaps in the seeded mask (iterations).
SCDL_ROI_DILATE=2
# Extra padding around bbox for seam-free composite.
SCDL_ROI_MARGIN=0.04

# pick ONE focus mode
SCDL_FOCUS_MODE=defocus        # or: dof, or: off

# defocus (compositor) knobs
SCDL_DEFOCUS_FSTOP=4        # lower = stronger blur (128 ≈ no blur)
SCDL_DEFOCUS_ZSCALE=1.0
SCDL_DEFOCUS_MAXBLUR=32.0
# optional safety margin so mask fits well inside the ROI crop
SCDL_ROI_BORDER_PAD=0.02

# camera DOF knobs (only used if SCDL_FOCUS_MODE=dof)
SCDL_FOCUS_FSTOP=1.8           # lower = stronger bokeh
SCDL_FOCUS_DISTANCE=2.0        # meters; ignored if focus object is set
SCDL_FOCUS_OBJECT=             # optional: name of an object to focus on




# -------- Notes --------
# - Preview resolution keeps the .blend render aspect automatically; adjust short side in blender_steps.py if needed.
# - For feathered edges in the Blender ROI composite, ask to switch to a matte-based blend using the saved mask.

# -------- Preview (Blender) --------
# Short side of preview in pixels (aspect preserved)
SCDL_PREVIEW_SHORT=448
# Cycles spp for preview fallback
SCDL_PREVIEW_SPP=16
# Denoise the preview before passing to DINO (0=No, 1=Yes). Helps DINO see structure in noisy renders.
SCDL_PREVIEW_DENOISE=1
# Cycles device override for headless Blender sessions (CPU, GPU, CUDA, OPTIX, etc.)
SCDL_CYCLES_DEVICE=OPTIX

# -------- Logging --------
# Options: stdout | file | both
SCDL_LOG_MODE=both
# Optional explicit log path (defaults to out/scdl_pipeline.log)
# SCDL_LOG_FILE=/path/to/pipeline.log

# -------- ROI render knobs (Blender path) --------
SCDL_ROI_CYCLES_SPP=1024
SCDL_ROI_CYCLES_ADAPTIVE=1
SCDL_ROI_CYCLES_THRESHOLD=0.05
# Base Cycles pass that fills the background before compositing the ROI
SCDL_BASE_CYCLES_SPP=128
SCDL_BASE_CYCLES_THRESHOLD=0.08
